# 自动更新功能使用指南

## 🎉 功能概述

ESP8266时钟现在支持自动检测和更新GitHub上发布的最新固件版本！

### ✨ 主要特性

- ✅ **自动检测** - 定期检查GitHub上的最新版本
- ✅ **智能比较** - 自动比较版本号，判断是否需要更新
- ✅ **一键更新** - 通过串口命令一键更新到最新版本
- ✅ **自动构建URL** - 根据版本号自动构建固件下载地址
- ✅ **灵活配置** - 支持手动或自动更新模式

---

## 📋 串口命令

| 命令 | 功能 | 说明 |
|------|------|------|
| `c` | 检查最新版本 | 查询GitHub上的最新版本号 |
| `a` | 检查并自动更新 | 检测到新版本后自动下载并安装 |
| `u` | 手动更新 | 使用配置的URL进行更新 |
| `o` | 显示OTA状态 | 查看当前OTA状态和进度 |
| `v` | 设置固件URL | 配置自定义的固件下载地址 |

---

## 🚀 使用方法

### 方法1：手动检查并更新（推荐）

#### 步骤1：检查最新版本

打开串口监视器（波特率115200），发送命令：
```
c
```

**输出示例：**
```
[时间] Checking for latest version...
[时间] Latest version: v2.2.0
[时间] Current version: v2.1.0
[时间] New version available!
[时间] Send 'a' to auto-update or 'u' to update manually
```

#### 步骤2：自动更新

如果有新版本，发送命令：
```
a
```

**输出示例：**
```
[时间] Checking and updating to latest version...
========================================
  Checking for OTA Updates
========================================
Current version: v2.1.0
Latest version: v2.2.0
New version available!
Firmware URL: https://github.com/chakoe/esp8266_ssd1306_Clock/releases/download/v2.2.0/esp8266_ssd1306_Clock.ino.bin
Starting OTA update...
========================================
[时间] OTA Update started
[时间] OTA Update Progress: 10%
[时间] OTA Update Progress: 20%
...
[时间] OTA Update Progress: 100%
[时间] OTA Update successful
[时间] Device will restart automatically
```

#### 步骤3：验证更新

设备重启后，再次发送 `c` 命令确认版本：
```
[时间] Latest version: v2.2.0
[时间] Current version: v2.2.0
[时间] Already up to date
```

---

### 方法2：启用自动更新（后台自动）

#### 配置自动更新

在 `esp8266_ssd1306_Clock.ino` 的 `setup()` 函数中取消注释：

```cpp
// 启用自动更新检查
otaConfig.autoUpdateEnabled = true;
otaConfig.checkInterval = 86400000; // 24小时检查一次
```

#### 工作原理

1. 设备启动后，每24小时自动检查一次更新
2. 如果有新版本，自动下载并安装
3. 安装完成后自动重启
4. 无需用户干预

#### 注意事项

⚠️ **生产环境建议：**
- 先在测试设备上验证新版本
- 确认无问题后再启用自动更新
- 保持更新日志，追踪版本变化

---

### 方法3：一键检查并更新

直接发送 `a` 命令，设备会：
1. 检查GitHub上的最新版本
2. 比较版本号
3. 如果有新版本，自动下载并安装
4. 如果已是最新版本，提示"Already up to date"

---

## 🔧 技术实现

### 工作流程

```
1. 用户发送 'a' 命令
   ↓
2. 调用 checkAndUpdateToLatest()
   ↓
3. 调用 getLatestVersionFromGitHub()
   ↓
4. 通过GitHub API获取最新Release
   ↓
5. 解析JSON获取tag_name（版本号）
   ↓
6. 调用 isNewerVersion() 比较版本
   ↓
7. 如果需要更新，调用 buildFirmwareUrl()
   ↓
8. 构建固件下载URL
   ↓
9. 调用 startOtaUpdate() 开始更新
   ↓
10. 下载固件并写入Flash
    ↓
11. 设备自动重启
    ↓
12. 新固件运行
```

### GitHub API调用

**API端点：**
```
https://api.github.com/repos/chakoe/esp8266_ssd1306_Clock/releases/latest
```

**响应示例：**
```json
{
  "tag_name": "v2.2.0",
  "name": "Release v2.2.0",
  "body": "Bug fixes and new features",
  "html_url": "https://github.com/chakoe/esp8266_ssd1306_Clock/releases/tag/v2.2.0"
}
```

**解析过程：**
1. 发送HTTP GET请求
2. 接收JSON响应
3. 查找 `"tag_name"` 字段
4. 提取版本号（如 "v2.2.0"）

### URL构建

**模板：**
```
https://github.com/chakoe/esp8266_ssd1306_Clock/releases/download/{version}/esp8266_ssd1306_Clock.ino.bin
```

**示例：**
```
版本: v2.2.0
URL: https://github.com/chakoe/esp8266_ssd1306_Clock/releases/download/v2.2.0/esp8266_ssd1306_Clock.ino.bin
```

---

## 📊 编译结果

| 项目 | 数值 |
|------|------|
| **状态** | ✅ 成功 |
| **固件大小** | 928 KB |
| **RAM使用** | 41,340 / 80,192 (51%) |
| **Flash使用** | 928,164 / 1,048,576 (88%) |

---

## 🎯 使用场景

### 场景1：开发测试

```
1. 开发新功能
2. 编译固件
3. 发布到GitHub (v2.2.0)
4. 设备发送 'c' 检查
5. 检测到新版本
6. 发送 'a' 更新
7. 验证新功能
```

### 场景2：生产部署

```
1. 在测试设备上验证
2. 确认无问题
3. 发布到GitHub
4. 批量设备启用自动更新
5. 设备自动更新
6. 监控更新成功率
```

### 场景3：紧急修复

```
1. 发现严重bug
2. 快速修复
3. 发布到GitHub
4. 用户发送 'a' 命令
5. 立即更新到修复版本
```

---

## ⚙️ 配置选项

### 自动更新间隔

```cpp
// 在setup()中配置
otaConfig.checkInterval = 86400000; // 24小时（毫秒）
```

**常用间隔：**
- `3600000` - 1小时
- `86400000` - 24小时（推荐）
- `604800000` - 7天
- `2592000000` - 30天

### 启用/禁用自动更新

```cpp
// 启用自动更新
otaConfig.autoUpdateEnabled = true;

// 禁用自动更新
otaConfig.autoUpdateEnabled = false;
```

---

## ⚠️ 注意事项

### 更新前检查

- ✅ 确保设备连接到WiFi
- ✅ 确保网络连接稳定
- ✅ 确认GitHub可访问
- ✅ 备份当前配置

### 更新过程中

- ⏱️ 不要断开WiFi连接
- ⏱️ 不要断开设备电源
- ⏱️ 等待更新完成
- ⏱️ 设备会自动重启

### 更新失败处理

1. 检查串口日志了解错误
2. 验证网络连接
3. 确认GitHub版本已发布
4. 使用串口上传恢复固件

---

## 🛠️ 故障排除

### 问题1：检查版本失败

**错误信息：**
```
Failed to get latest version from GitHub
```

**解决方法：**
1. 检查WiFi连接
2. 确认GitHub可访问
3. 检查网络代理设置
4. 验证GitHub API限制

### 问题2：更新失败

**错误信息：**
```
OTA update failed: HTTP_UPDATE_FAILED
```

**解决方法：**
1. 验证固件URL是否正确
2. 确认固件文件已上传
3. 检查Flash空间是否足够
4. 重新编译固件

### 问题3：版本比较错误

**现象：**
- 显示有新版本，但实际没有
- 或不显示新版本，但实际有

**解决方法：**
1. 确认版本号格式一致（vX.Y.Z）
2. 检查GitHub Release标签
3. 验证当前版本配置

### 问题4：自动更新不工作

**现象：**
- 启用自动更新后，设备不更新

**解决方法：**
1. 确认 `autoUpdateEnabled = true`
2. 检查 `checkInterval` 设置
3. 查看日志是否有错误
4. 手动触发测试

---

## 📖 最佳实践

### 1. 版本管理

- ✅ 使用语义化版本号（v2.1.0）
- ✅ 保持文件名不变
- ✅ 记录更新日志
- ✅ 测试后再发布

### 2. 更新策略

- ✅ 先在测试设备验证
- ✅ 分批更新生产设备
- ✅ 监控更新成功率
- ✅ 保留回滚方案

### 3. 安全考虑

- ✅ 使用HTTPS URL
- ✅ 验证固件签名（可选）
- ✅ 限制更新频率
- ✅ 记录更新日志

---

## 🎊 总结

### 主要功能

✅ **自动检测** - 定期检查GitHub最新版本
✅ **智能比较** - 自动判断是否需要更新
✅ **一键更新** - 通过串口命令快速更新
✅ **自动构建URL** - 根据版本号自动生成下载地址
✅ **灵活配置** - 支持手动和自动模式

### 使用流程

```
检查版本 (c) → 发现新版本 → 自动更新 (a) → 重启 → 完成
```

### 快速命令

```
c - 检查最新版本
a - 检查并自动更新
o - 查看OTA状态
u - 手动更新
v - 设置URL
```

---

## 🔗 相关资源

- **GitHub Releases**：https://github.com/chakoe/esp8266_ssd1306_Clock/releases
- **OTA使用指南**：`OTA使用指南.md`
- **OTA快速开始**：`OTA快速开始.md`
- **GitHub配置指南**：`GitHub_Releases配置指南.md`

---

**自动更新功能已完全实现！现在您的设备可以自动检测并更新到最新版本了！** 🚀
